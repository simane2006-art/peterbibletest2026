<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ™‚éš¨æ©Ÿæ¸¬é©—ç³»çµ± (é€²éšé›²ç«¯ç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        .admin-container { max-width: 800px; overflow-x: auto; }
        input[type="text"], input[type="password"] { width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; margin: 10px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .option-btn { display: block; width: 100%; margin: 10px 0; background-color: #e9ecef; color: #333; text-align: left; }
        .option-btn:hover { background-color: #d3d9df; }
        #timer { font-size: 20px; font-weight: bold; color: #dc3545; margin-bottom: 20px; }
        .hidden { display: none; }
        .question-text { font-size: 18px; margin-bottom: 20px; font-weight: bold; }
        .score-info { font-size: 14px; color: #666; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 650px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        ol.leaderboard-list { text-align: left; font-size: 18px; display: inline-block; padding-left: 20px; }
        ol.leaderboard-list li { margin: 15px 0; font-weight: bold; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

<div class="container" id="login-screen">
    <h2>ğŸ” ç³»çµ±ç™»å…¥</h2>
    <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ (Sapling/Devotion/manager101)"><br>
    <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"><br>
    <button onclick="login()">ç™»å…¥</button>
</div>

<div class="container hidden" id="menu-screen">
    <h2>ğŸ“± ä¸»é¸å–®</h2>
    <p>Cell: <span id="display-cell" style="font-weight:bold; color:#007bff;"></span></p>
    <button onclick="showNameScreen()">â–¶ï¸ é–‹å§‹æ¸¬é©—</button>
    <button onclick="showLeaderboard()">ğŸ† æŸ¥çœ‹æˆç¸¾ (Top 5)</button>
    <br><br>
    <button class="btn-danger" onclick="logout()">ç™»å‡º</button>
</div>

<div class="container hidden" id="leaderboard-screen">
    <h2>ğŸ† æœ€é«˜åˆ† Top 5 æ’è¡Œæ¦œ</h2>
    <hr>
    <ol id="top5-list" class="leaderboard-list">
        </ol>
    <br>
    <button class="btn-secondary" onclick="goBackToMenu()">ğŸ”™ è¿”å›ä¸»é¸å–®</button>
</div>

<div class="container hidden" id="name-screen">
    <h2>ğŸ“ æº–å‚™é–‹å§‹</h2>
    <p>è«‹è¼¸å…¥ä½ çš„çœŸå¯¦å§“å (æ¯å€‹å§“ååªå¯ä½œç­”ä¸€æ¬¡)ï¼š</p>
    <input type="text" id="user-real-name" placeholder="ä¾‹å¦‚ï¼šé™³å¤§æ–‡"><br>
    <button id="submit-name-btn" onclick="submitName()">é©—è­‰ä¸¦ä¸‹ä¸€æ­¥</button>
    <button class="btn-secondary" onclick="goBackToMenu()">è¿”å›</button>
</div>

<div class="container hidden" id="personal-score-screen">
    <h2>âš ï¸ ä½ å·²ç¶“å®Œæˆéæ¸¬é©—ï¼</h2>
    <p>ç³»çµ±ç´€éŒ„é¡¯ç¤ºä½ å·²ç¶“ä½œç­”éï¼Œä»¥ä¸‹ä¿‚ä½ ç•¶æ™‚å˜…æˆç¸¾ï¼š</p>
    <h1 id="personal-score-display" style="color: #007bff;"></h1>
    <button class="btn-secondary" onclick="goBackToMenu()">ğŸ”™ è¿”å›ä¸»é¸å–®</button>
</div>

<div class="container hidden" id="setup-screen">
    <h2>ğŸ“ é¸æ“‡é›£åº¦</h2>
    <p><span id="display-name" style="font-weight:bold;"></span>ï¼Œè«‹é¸æ“‡ï¼š</p>
    <button onclick="startQuiz(10, 10, 100, 'ä½é›£åº¦')">ğŸŸ¢ ä½é›£åº¦ (10åˆ†é˜)</button>
    <button onclick="startQuiz(5, 12.5, 125, 'ä¸­é›£åº¦')">ğŸŸ¡ ä¸­é›£åº¦ (5åˆ†é˜)</button>
    <button onclick="startQuiz(2, 15, 150, 'é«˜é›£åº¦')">ğŸ”´ é«˜é›£åº¦ (2åˆ†é˜)</button>
</div>

<div class="container hidden" id="quiz-screen">
    <div id="timer">å‰©é¤˜æ™‚é–“: <span id="time-left">00:00</span></div>
    <div id="progress">ç¬¬ <span id="current-q-num">1</span> / 10 é¡Œ</div>
    <div class="score-info" id="score-info">æ¯é¡Œ 0 åˆ†</div>
    <hr>
    <div class="question-text" id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
    <div id="options-container"></div>
</div>

<div class="container hidden" id="result-screen">
    <h2>ğŸ‰ æ¸¬é©—çµæŸï¼</h2>
    <p>æˆç¸¾å·²å®‰å…¨ä¸Šå‚³è‡³é›²ç«¯</p>
    <p>ä½ çš„å¾—åˆ†æ˜¯ï¼š</p>
    <h1 id="score-display">0 / 0</h1>
    <button onclick="logout()">è¿”å›é¦–é </button>
</div>

<div class="container admin-container hidden" id="admin-screen">
    <h2>ğŸ“Š é›²ç«¯æ¸¬é©—æˆç¸¾å¾Œå°</h2>
    <button onclick="logout()">ç™»å‡º</button>
    <button class="btn-danger" onclick="clearRecords()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
    <p id="loading-text" style="color: #007bff; font-weight: bold;"></p>
    <table>
        <thead>
            <tr>
                <th>å®Œæˆæ—¥æœŸåŠæ™‚é–“</th>
                <th>Cell å¸³è™Ÿ</th>
                <th>å§“å</th>
                <th>é›£åº¦</th>
                <th>åˆ†æ•¸</th>
            </tr>
        </thead>
        <tbody id="admin-table-body"></tbody>
    </table>
</div>

<script>
    // âœ… å·²åŠ å…¥ä½ çš„å°ˆå±¬ Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyCud2BDeVczN5h_bi9SVF6Bi0A1DX3gPfU",
        authDomain: "peterbiblereading2026.firebaseapp.com",
        projectId: "peterbiblereading2026",
        storageBucket: "peterbiblereading2026.firebasestorage.app",
        messagingSenderId: "543051702211",
        appId: "1:543051702211:web:664cd107cc446f5a16a776",
        measurementId: "G-M7305J8L6J"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const questionBank = [
        { question: "é¦™æ¸¯æœ€é«˜å˜…å±±å³°ä¿‚é‚Šåº§ï¼Ÿ", options: ["ç…å­å±±", "å¤§å¸½å±±", "é³³å‡°å±±", "å¤ªå¹³å±±"], answer: 1 },
        { question: "ä¸–ç•Œä¸Šæœ€å¤§å˜…æµ·æ´‹ä¿‚é‚Šå€‹ï¼Ÿ", options: ["å¤§è¥¿æ´‹", "å°åº¦æ´‹", "å¤ªå¹³æ´‹", "åŒ—å†°æ´‹"], answer: 2 },
        { question: "äººé¡ç¬¬ä¸€æ¬¡ç™»é™¸æœˆçƒä¿‚é‚Šä¸€å¹´ï¼Ÿ", options: ["1965", "1969", "1972", "1980"], answer: 1 },
        { question: "å¤ªé™½ç³»å…¥é¢æœ€å¤§å˜…è¡Œæ˜Ÿä¿‚ï¼Ÿ", options: ["ç«æ˜Ÿ", "åœ°çƒ", "åœŸæ˜Ÿ", "æœ¨æ˜Ÿ"], answer: 3 },
        { question: "é‚Šç¨®å‹•ç‰©è¢«ç¨±ç‚ºã€Œè¬ç¸ä¹‹ç‹ã€ï¼Ÿ", options: ["ç…å­", "è€è™", "å¤§è±¡", "çŠ€ç‰›"], answer: 0 },
        { question: "æ°´å˜…åŒ–å­¸ç¬¦è™Ÿä¿‚å’©ï¼Ÿ", options: ["CO2", "O2", "H2O", "HO2"], answer: 2 },
        { question: "é¦™æ¸¯å˜…å€èŠ±ä¿‚å’©ï¼Ÿ", options: ["æ¢…èŠ±", "æ´‹ç´«èŠ", "æœ¨æ£‰èŠ±", "è·èŠ±"], answer: 1 },
        { question: "ä¸€å¹´æœ‰å¹¾å¤šå€‹æœˆä»½æœ‰ 31 æ—¥ï¼Ÿ", options: ["5å€‹", "6å€‹", "7å€‹", "8å€‹"], answer: 2 },
        { question: "ä¸–ç•Œä¸Šæœ€é•·å˜…æ²³æµä¿‚ï¼Ÿ", options: ["å°¼ç¾…æ²³", "äºé¦¬éœæ²³", "é•·æ±Ÿ", "å¯†è¥¿è¥¿æ¯”æ²³"], answer: 0 },
        { question: "åœ“å‘¨ç‡ (Pi) å˜…å¤§ç´„æ•¸å€¼ä¿‚ï¼Ÿ", options: ["3.12", "3.14", "3.16", "3.18"], answer: 1 },
        { question: "ã€Šè’™å¨œéº—èã€‹ä¿‚é‚Šä½è‘—åç•«å®¶å˜…ä½œå“ï¼Ÿ", options: ["æ¢µé«˜", "ç•¢åŠ ç´¢", "ç±³é«˜å®‰å“²ç¾…", "é”æ–‡è¥¿"], answer: 3 },
        { question: "äººé«”æœ€å¤§å˜…å™¨å®˜ä¿‚å’©ï¼Ÿ", options: ["çš®è†š", "è‚è‡Ÿ", "è‚º", "å¤§è…¦"], answer: 0 },
        { question: "å¥§é‹æœƒæ¨™èªŒæœ‰å¹¾å¤šå€‹åœ“ç’°ï¼Ÿ", options: ["4å€‹", "5å€‹", "6å€‹", "7å€‹"], answer: 1 },
        { question: "é‚Šå€‹åœ‹å®¶ä¿‚ç™¼æ˜å£½å¸å˜…ç™¼æºåœ°ï¼Ÿ", options: ["éŸ“åœ‹", "ä¸­åœ‹", "æ—¥æœ¬", "æ³°åœ‹"], answer: 2 },
        { question: "å…‰é€Ÿå¤§ç´„æ¯ç§’å¹¾å¤šè¬å…¬é‡Œï¼Ÿ", options: ["30è¬", "40è¬", "50è¬", "60è¬"], answer: 0 },
        { question: "è‘—åæ™¯é»ã€Œå¤§ä¸‰å·´ç‰ŒåŠã€å–ºé‚Šå€‹åŸå¸‚ï¼Ÿ", options: ["ç æµ·", "æ¾³é–€", "å»£å·", "æ·±åœ³"], answer: 1 },
        { question: "ä¸­åœ‹å¤ä»£å››å¤§ç™¼æ˜ã€Œä¸åŒ…æ‹¬ã€ä»¥ä¸‹é‚Šä¸€æ¨£ï¼Ÿ", options: ["æŒ‡å—é‡", "ç«è—¥", "é€ ç´™è¡“", "åœ°å‹•å„€"], answer: 3 },
        { question: "å“ˆåˆ©æ³¢ç‰¹é¡é ­ä¸Šé¢å˜…ç–¤ç—•ä¿‚å’©å½¢ç‹€ï¼Ÿ", options: ["æ˜Ÿæ˜Ÿ", "æœˆäº®", "é–ƒé›»", "åå­—"], answer: 2 },
        { question: "åœ°çƒä¸Šç¸½å…±æœ‰å¹¾å¤šå€‹å¤§æ´²ï¼Ÿ", options: ["5å€‹", "6å€‹", "7å€‹", "8å€‹"], answer: 2 },
        { question: "ä¸€å‰¯å®Œæ•´å˜…æ’²å…‹ç‰Œï¼ˆå””è¨ˆé¬¼ç‰Œ/Jokerï¼‰æœ‰å¹¾å¤šéš»ï¼Ÿ", options: ["52éš»", "54éš»", "56éš»", "58éš»"], answer: 0 }
    ];

    let currentUserCell = ""; let currentUserName = ""; let selectedDifficultyName = "";
    let selectedQuestions = []; let currentQuestionIndex = 0; let score = 0;
    let pointsPerQuestion = 0; let maxScore = 0; let timerInterval; let timeRemaining = 0;

    function showScreen(screenId) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
    }

    function login() {
        const user = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value;
        if (pass !== "Peter2026") { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); return; }
        
        if (user === "manager101") {
            showScreen('admin-screen');
            loadAdminRecords();
        } else if (user === "Sapling" || user === "Devotion") {
            currentUserCell = user;
            document.getElementById('display-cell').innerText = user;
            showScreen('menu-screen');
        } else { 
            alert("å¸³è™Ÿä¸å­˜åœ¨ï¼è«‹è¼¸å…¥ Sapling, Devotion æˆ– manager101"); 
        }
    }

    function showNameScreen() {
        document.getElementById('user-real-name').value = '';
        showScreen('name-screen');
    }

    function goBackToMenu() {
        showScreen('menu-screen');
    }

    async function submitName() {
        const nameInput = document.getElementById('user-real-name').value.trim();
        if (!nameInput) { alert("è«‹è¼¸å…¥ä½ çš„çœŸå¯¦å§“åï¼"); return; }
        
        const btn = document.getElementById('submit-name-btn');
        btn.innerText = "é©—è­‰ä¸­...";
        btn.disabled = true;

        try {
            const snapshot = await db.collection("quizRecords").where("name", "==", nameInput).get();
            
            if (!snapshot.empty) {
                const recordData = snapshot.docs[0].data();
                document.getElementById('personal-score-display').innerText = `${recordData.score} (é›£åº¦: ${recordData.difficulty})`;
                showScreen('personal-score-screen');
            } else {
                currentUserName = nameInput;
                document.getElementById('display-name').innerText = currentUserName;
                showScreen('setup-screen');
            }
        } catch (error) {
            console.error("é©—è­‰å§“åå¤±æ•—: ", error);
            alert("é€£æ¥ä¼ºæœå™¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šã€‚");
        } finally {
            btn.innerText = "é©—è­‰ä¸¦ä¸‹ä¸€æ­¥";
            btn.disabled = false;
        }
    }

    async function showLeaderboard() {
        showScreen('leaderboard-screen');
        const list = document.getElementById('top5-list');
        list.innerHTML = "<li>è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</li>";

        try {
            const snapshot = await db.collection("quizRecords").orderBy("numericScore", "desc").limit(5).get();
            list.innerHTML = "";

            if (snapshot.empty) {
                list.innerHTML = "<li>æš«æ™‚æœªæœ‰ä»»ä½•æˆç¸¾è¨˜éŒ„ã€‚</li>";
                return;
            }

            let rank = 1;
            const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£"];
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const li = document.createElement('li');
                li.innerHTML = `${medals[rank-1]} ${data.name} <span style="color:#007bff; float:right;">${data.score}</span>`;
                list.appendChild(li);
                rank++;
            });
        } catch (error) {
            console.error("è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—: ", error);
            list.innerHTML = "<li>è¼‰å…¥å¤±æ•—ï¼Œå¯èƒ½éœ€è¦é¦–æ¬¡å»ºç«‹è³‡æ–™åº«ç´¢å¼•ï¼Œæˆ–æª¢æŸ¥ç¶²çµ¡ã€‚</li>";
        }
    }

    function shuffleArray(array) {
        let shuffled = array.slice();
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function startQuiz(minutes, points, max, difficultyName) {
        pointsPerQuestion = points; maxScore = max; selectedDifficultyName = difficultyName;
        score = 0; currentQuestionIndex = 0;
        
        showScreen('quiz-screen');
        document.getElementById('score-info').innerText = `æ¯é¡Œ ${pointsPerQuestion} åˆ†`;
        
        selectedQuestions = shuffleArray(questionBank).slice(0, 10);
        timeRemaining = minutes * 60;
        updateTimerDisplay();
        timerInterval = setInterval(countdown, 1000);
        loadQuestion();
    }

    function countdown() {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) endQuiz();
    }

    function updateTimerDisplay() {
        let minutes = Math.floor(timeRemaining / 60); 
        let seconds = timeRemaining % 60;
        document.getElementById('time-left').innerText = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function loadQuestion() {
        if (currentQuestionIndex >= 10) { endQuiz(); return; }
        const currentQ = selectedQuestions[currentQuestionIndex];
        document.getElementById('current-q-num').innerText = currentQuestionIndex + 1;
        document.getElementById('question-text').innerText = currentQ.question;
        
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        currentQ.options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn'; 
            btn.innerText = opt;
            btn.onclick = () => selectAnswer(index);
            optionsContainer.appendChild(btn);
        });
    }

    function selectAnswer(selectedIndex) {
        if (selectedIndex === selectedQuestions[currentQuestionIndex].answer) score += pointsPerQuestion;
        currentQuestionIndex++;
        loadQuestion();
    }

    function endQuiz() {
        clearInterval(timerInterval);
        showScreen('result-screen');
        const finalScoreText = `${score} / ${maxScore}`;
        document.getElementById('score-display').innerText = "ä¸Šå‚³ä¸­...";

        // æ ¼å¼åŒ–æ—¥æœŸåŠæ™‚é–“
        const now = new Date();
        const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

        db.collection("quizRecords").add({
            date: formattedDate, // æ¸…æ™°çš„æ—¥æœŸæ™‚é–“æ ¼å¼
            cell: currentUserCell,
            name: currentUserName,
            difficulty: selectedDifficultyName,
            score: finalScoreText,
            numericScore: score, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('score-display').innerText = finalScoreText;
        }).catch((error) => {
            alert("ä¸Šå‚³æˆç¸¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šã€‚");
        });
    }

    function loadAdminRecords() {
        const tbody = document.getElementById('admin-table-body');
        const loadingText = document.getElementById('loading-text');
        tbody.innerHTML = '';
        loadingText.innerText = "è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...";

        db.collection("quizRecords").orderBy("timestamp", "desc").get().then((querySnapshot) => {
            loadingText.innerText = "";
            if (querySnapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="5">æš«æ™‚æœªæœ‰æ¸¬é©—è¨˜éŒ„</td></tr>';
                return;
            }
            querySnapshot.forEach((doc) => {
                const record = doc.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.date || 'æœªçŸ¥æ™‚é–“'}</td>
                    <td>${record.cell}</td>
                    <td>${record.name}</td>
                    <td>${record.difficulty}</td>
                    <td style="font-weight:bold; color:#007bff;">${record.score}</td>
                `;
                tbody.appendChild(tr);
            });
        }).catch((error) => {
            loadingText.innerText = "è¼‰å…¥å¤±æ•—ï¼";
        });
    }

    function clearRecords() {
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¸¬é©—è¨˜éŒ„å—ï¼Ÿå‘¢å€‹æ“ä½œç„¡æ³•å¾©åŸï¼")) {
            const loadingText = document.getElementById('loading-text');
            loadingText.innerText = "æ­£åœ¨æ¸…é™¤è³‡æ–™...";
            
            db.collection("quizRecords").get().then((querySnapshot) => {
                const batch = db.batch();
                querySnapshot.forEach((doc) => { batch.delete(doc.ref); });
                return batch.commit();
            }).then(() => {
                alert("å·²æˆåŠŸæ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼");
                loadAdminRecords();
            }).catch((error) => {
                alert("æ¸…é™¤å¤±æ•—ï¼");
            });
        }
    }

    function logout() {
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('user-real-name').value = '';
        currentUserCell = ""; currentUserName = "";
        showScreen('login-screen');
    }
</script>

</body>
</html>